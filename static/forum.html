<!-- ✅ forum.html - 论坛主页（发帖 + 帖子列表） --><!DOCTYPE html><html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZSY论坛</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f9f9f9; }
    header { background: #fff; padding: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .avatar { width: 32px; height: 32px; border-radius: 50%; }
    .post-box { padding: 12px; background: #fff; margin: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    input, textarea { width: 100%; margin: 6px 0; padding: 10px; font-size: 1em; }
    button { padding: 10px 18px; border: none; border-radius: 6px; background: #4caf50; color: white; font-weight: bold; cursor: pointer; }
    .post-item { display: flex; flex-direction: column; background: #fff; padding: 12px; margin: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; gap: 10px; }
    .post-title { font-size: 1.1em; font-weight: bold; margin-top: 6px; color: #007bff; text-decoration: none; }
    .post-meta { font-size: 0.85em; color: #666; margin-top: 4px; }
  </style>
</head>
<body>
  <header>
    <div><img id="my-avatar" class="avatar"> <span id="my-username"></span></div>
    <div>
      <button onclick="location.href='/'">🏠</button>
      <button onclick="deleteAvatar()">🗑</button>
    </div>
  </header>  <div class="post-box">
    <h3>📝 发帖</h3>
    <input id="title" placeholder="标题">
    <textarea id="content" rows="4" placeholder="内容"></textarea>
    <button onclick="submitPost()">发布</button>
  </div>  <div id="posts"></div><script>
const token = localStorage.getItem("zsy_token");
const username = localStorage.getItem("zsy_username");
document.getElementById("my-username").innerText = username;

fetch("/api/user-avatar", { headers: { Authorization: "Bearer " + token } })
  .then(r => r.json()).then(d => {
    document.getElementById("my-avatar").src = d.url || `https://api.dicebear.com/7.x/bottts/svg?seed=${username}`;
  });

function deleteAvatar() {
  fetch("/api/delete-avatar", { method: "POST", headers: { Authorization: "Bearer " + token } })
    .then(r => r.json()).then(d => { if (d.success) location.reload(); });
}

function submitPost() {
  fetch("/rest/v1/posts", {
    method: "POST",
    headers: {
      "apikey": "<服务密钥>", "Authorization": "Bearer <服务密钥>",
      "Content-Type": "application/json", "Prefer": "return=representation"
    },
    body: JSON.stringify({ title: title.value, content: content.value, username })
  }).then(() => location.reload());
}

function loadPosts() {
  fetch("/rest/v1/posts?order=created_at.desc", {
    headers: { apikey: "<匿名密钥>", Authorization: "Bearer " + token }
  }).then(r => r.json()).then(data => {
    const box = document.getElementById("posts");
    data.forEach(p => {
      const div = document.createElement("div");
      div.className = "post-item";

      const header = document.createElement("div");
      header.className = "post-header";
      const img = document.createElement("img");
      img.className = "avatar";
      loadAvatar(p.username, img);
      const userSpan = document.createElement("span");
      userSpan.innerText = p.username;
      header.appendChild(img);
      header.appendChild(userSpan);

      const titleLink = document.createElement("a");
      titleLink.className = "post-title";
      titleLink.href = "/forum/post?id=" + p.id;
      titleLink.innerText = p.title;

      const meta = document.createElement("div");
      meta.className = "post-meta";
      meta.innerText = new Date(p.created_at).toLocaleString();

      div.appendChild(header);
      div.appendChild(titleLink);
      div.appendChild(meta);
      box.appendChild(div);
    });
  });
}

function loadAvatar(user, img) {
  fetch("/api/avatar-by-username?username=" + user)
    .then(r => r.json())
    .then(d => img.src = d.url || `https://api.dicebear.com/7.x/bottts/svg?seed=${user}`);
}

loadPosts();
</script></body>
</html>
