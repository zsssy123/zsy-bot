<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZSY èŠå¤©å®¤</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      display: flex;
      height: 100vh;
      font-family: "Segoe UI", sans-serif;
    }
    #sidebar {
      width: 260px;
      background: #f5f7fa;
      border-right: 1px solid #ddd;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #chat-list {
      flex: 1;
      overflow-y: auto;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #eef1f5;
    }
    #header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #ffffff;
      border-bottom: 1px solid #ccc;
    }
    #header img {
      border-radius: 50%;
      margin-right: 12px;
    }
    #header .title {
      font-weight: bold;
      font-size: 1.1em;
    }
    #chat {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .message.user { align-self: flex-end; flex-direction: row-reverse; }
    .message.bot { align-self: flex-start; }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    .bubble {
      background: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      max-width: 80%;
      line-height: 1.6;
    }
    .message.bot .bubble {
      background: #e2f5d3;
    }
    #input-bar {
      display: flex;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #ccc;
      gap: 8px;
    }
    #msg {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 1em;
      outline: none;
    }
    #send-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background: #28a745;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    #user-info {
      margin-left: auto;
    }
    .chat-item:hover {
      background: #e3f2fd;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <div><strong>ğŸ’¬ æˆ‘çš„å¯¹è¯</strong></div>
    <div id="chat-list"></div>
    <button id="new-chat-btn">â• æ–°å»ºä¼šè¯</button>
  </div>

  <div id="main">
    <div id="header">
      <img src="https://p3.itc.cn/q_70/images01/20230927/a33685f0ad954b2bae29a8e1e1c05cda.png" width="40" />
      <div class="title">ZSY AI æœºå™¨äºº</div>
      <div id="user-info"></div>
    </div>
    <div style="text-align: right; padding: 0 16px 10px;">
        <a href="/" style="
          font-size: 0.9em;
          background: #007bff;
          color: white;
          padding: 6px 12px;
          border-radius: 6px;
          text-decoration: none;
          margin-right: 10px;
        ">ğŸ  è¿”å›é¦–é¡µ</a>

        <a href="/changepwd" style="
          font-size: 0.9em;
          background: #ffc107;
          color: black;
          padding: 6px 12px;
          border-radius: 6px;
          text-decoration: none;
        ">ğŸ”‘ ä¿®æ”¹å¯†ç </a>
      </div>
    <!-- åŠŸèƒ½å¼€å…³åŒº -->
    <div style="display: flex; justify-content: flex-end; gap: 16px; padding: 10px 16px; background: #fff;">
      <label style="font-size: 0.9em; color: #444;">
        <input type="checkbox" id="use-memory" checked />
        ä½¿ç”¨è®°å¿†åŠŸèƒ½
      </label>
      <label style="font-size: 0.9em; color: #444;">
        <input type="checkbox" id="zsy-mode" />
        ä½¿ç”¨ ZSY äººæ ¼
      </label>
    </div>

    <div id="chat"></div>

    <div id="input-bar">
      <input id="msg" placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦" autocomplete="off" />
      <button id="send-btn">å‘é€</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const token = localStorage.getItem("zsy_token");
    let currentChatId = localStorage.getItem("current_chat_id");

    const userInfoBox = document.getElementById("user-info");
    const username = localStorage.getItem("zsy_username") || "ZSYç”¨æˆ·";
    userInfoBox.innerHTML = `
      <span style="margin-left: 12px;">ğŸ‘¤ ${username}</span>
      <button onclick="logout()" style="margin-left: 8px;">é€€å‡º</button>
    `;
    function logout() {
      localStorage.clear();
      window.location.href = "/login";
    }

    function addMessage(text, sender = "bot") {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = sender === "bot"
        ? "https://p3.itc.cn/q_70/images01/20230927/a33685f0ad954b2bae29a8e1e1c05cda.png"
        : "https://cdn.pixabay.com/photo/2022/10/07/11/02/autumn-7504820_1280.jpg";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = text;

      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadChatHistory() {
      chat.innerHTML = "";
      const res = await fetch("/api/chat-list", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const list = await res.json();
      const match = list.find(c => c.id == currentChatId);
      if (!match && list.length > 0) {
        currentChatId = list[0].id;
        localStorage.setItem("current_chat_id", currentChatId);
      }

      if (!currentChatId) return;

      const sessionRes = await fetch(`/api/chat-list`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const sessionList = await sessionRes.json();
      const target = sessionList.find(item => item.id == currentChatId);
      if (!target) return;

      const detailsRes = await fetch(`/api/chat-update`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ id: currentChatId, messages: [] }) // è¿™é‡Œè·å–èŠå¤©å†…å®¹
      });

      const result = await detailsRes.json();
      if (Array.isArray(result)) {
        result.forEach(m => {
          if (m.role && m.content) {
            addMessage(m.content, m.role === "user" ? "user" : "bot");
          }
        });
      }
    }

    async function loadChatList() {
      const res = await fetch("/api/chat-list", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const list = await res.json();
      const box = document.getElementById("chat-list");
      box.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.textContent = `ğŸ’¬ ${item.summary}`;
        div.style.padding = "6px";
        div.style.borderRadius = "6px";
        div.style.cursor = "pointer";
        div.style.background = item.id == currentChatId ? "#d6eaff" : "#fff";
        div.onclick = () => {
          currentChatId = item.id;
          localStorage.setItem("current_chat_id", currentChatId);
          loadChatHistory();
          loadChatList();
          loadChatHistory(item.id);
        };
        box.appendChild(div);
      });
      const btn = document.getElementById("new-chat-btn");
      btn.disabled = list.length >= 3;
      btn.innerText = list.length >= 3 ? "ğŸ“Œ æœ€å¤š3ä¸ªä¼šè¯" : "â• æ–°å»ºä¼šè¯";
    }

    async function newChat() {
      const res = await fetch("/api/chat-create", {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.chatId) {
        currentChatId = data.chatId;
        localStorage.setItem("current_chat_id", currentChatId);
        await loadChatList();
        return data.chatId;  // âœ… è¿”å›æ–° chatId
      } else {
        alert("æ–°å»ºå¤±è´¥");
        return null;
      }
    }

    
    async function loadChatHistory() {
      if (!currentChatId) return;

      chat.innerHTML = "";  // æ¸…ç©ºç•Œé¢

      const res = await fetch(`/api/chat-get?id=${currentChatId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const session = await res.json();
      const messages = session?.messages || [];

      for (const m of messages) {
        addMessage(m.content, m.role === "user" ? "user" : "bot");
      }
    }


    async function send() {
      const text = input.value.trim();
      if (!text || !currentChatId) return;
      addMessage(text, "user");
      input.value = "";
      const useMemory = document.getElementById("use-memory").checked;
      const useZSYMode = document.getElementById("zsy-mode").checked;
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: text,
          chatId: currentChatId,
          useMemory,
          useZSYMode
        })
      });
      const result = await res.json();
      addMessage(result.reply || "[æ— å“åº”]", "bot");
    }

    document.getElementById("send-btn").onclick = send;
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") send();
    });

    window.addEventListener("DOMContentLoaded", async () => {
      await loadChatList();

      const lastChatId = localStorage.getItem("current_chat_id");

      if (!lastChatId) {
        const created = await newChat(); // ç­‰å¾…åˆ›å»ºæˆåŠŸå¹¶è¿”å› chatId
        if (created) {
          currentChatId = created;
          localStorage.setItem("current_chat_id", created);
          await loadChatHistory();
        }
      } else {
        currentChatId = lastChatId;
        await loadChatHistory();
      }
    });


  </script>

</body>
</html>
