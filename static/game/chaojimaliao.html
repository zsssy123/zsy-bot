<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…çº§é©¬é‡Œå¥¥å‡çº§ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            padding: 20px;
            overflow-x: hidden;
            color: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 3px solid #F8D568;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .title {
            font-size: 48px;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0 #E52521, 6æ 6px 0 rgba(0, 0, 0, 0.2);
            letter-spacing: 2px;
            color: #F8D568;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        .subtitle {
            font-size: 20px;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .game-container {
            position: relative;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            max-width: 100%;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
        }
        
        #gameCanvas {
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            display: block;
            border: 4px solid #8B4513;
            width: 800px;
            height: 500px;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            border-radius: 50px;
            margin: 20px 0;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .controls {
            display: flex;
            background: rgba(139, 69, 19, 0.8);
            padding: 15px 30px;
            border-radius: 50px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            justify-content: space-around;
        }
        
        .key {
            width: 70px;
            height: 70px;
            background: linear-gradient(to bottom, #f5f5f5, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 5px 0 #bbb;
            border: 2px solid #999;
            position: relative;
            transition: all 0.1s;
        }
        
        .key.active {
            transform: translateY(5px);
            box-shadow: 0 0px 0 #bbb;
            background: linear-gradient(to bottom, #e0e0e0, #d0d0d0);
        }
        
        .key::after {
            content: attr(data-action);
            position: absolute;
            top: -25px;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 1px black;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            margin-top: 20px;
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            border: 2px solid #FFD700;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 60px;
            border-radius: 20px;
            text-align: center;
            display: block;
            z-index: 10;
            border: 4px solid #FF5252;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .game-over.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        .game-over h2 {
            font-size: 48px;
            color: #FF5252;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.7);
        }
        
        .restart-btn {
            background: linear-gradient(to bottom, #4CAF50, #2E7D32);
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 0 #1B5E20;
        }
        
        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #4CAF50, 0 6px 0 #1B5E20;
        }
        
        .mushroom {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 35%, #FF5252, #D32F2F);
            border-radius: 50% 50% 5px 5px;
            position: relative;
            margin: 0 10px -10px;
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .mushroom::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 5px;
            width: 30px;
            height: 20px;
            background: white;
            border-radius: 50%;
        }
        
        .mushroom::after {
            content: "";
            position: absolute;
            top: -5px;
            left: 10px;
            width: 20px;
            height: 10px;
            background: #FFCCBC;
            border-radius: 50%;
        }
        
        .debug-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 16px;
            color: #FF9800;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .status-fix {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 16px;
            color: #4CAF50;
            display: none;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacityæ 1; }
        }
        
        .sound-control {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 16px;
            color: white;
            cursor: pointer;
        }
        
        .collision-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .collision-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5555;
        }
        
        .collision-status.active {
            background: #55ff55;
        }
        
        .map-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15æ;
            border-radius: 10px;
            font-size: 16px;
            color: #FFD700;
        }
        
        .ability-indicator {
            display: flex;
            gap: 10px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 10px;
        }
        
        .ability {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .ability-icon {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .ability-text {
            font-size: 12px;
        }
        
        @media (max-width: 850px) {
            .game-container, #gameCanvas {
                width: 100%;
                max-width: 100%;
            }
            
            #gameCanvas {
                height: auto;
                aspect-ratio: 16/10;
            }
            
            .stats-container, .controls {
                width: 100%;
                max-width: 100%;
                flex-wrap: wrap;
            }
            
            .key {
                width: 60px;
                height: 60px;
                font-size: 18px;
                margin: 5px;
            }
            
            .key::after {
                font-size: 12px;
                top: -20px;
            }
            
            .title {
                font-size: 36px;
            }
            
            .game-over {
                width: 90%;
                padding: 20px;
            }
            
            .game-over h2 {
                font-size: 36px;
            }
            
            .restart-btn {
                padding: 10px 25px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">è¶…çº§é©¬é‡Œå¥¥å‡çº§ç‰ˆ</h1>
        <div class="subtitle">WASDæ§åˆ¶ Â· æ›´å¤šæ€ªç‰© Â· ç –å—æ¥¼æ¢¯</div>
    </div>
    
    <div class="stats-container">
        <div>å¾—åˆ†: <span id="score">0</span></div>
        <div>é‡‘å¸: <span id="coins">0</span> <span class="mushroom"></span></div>
        <div>ç”Ÿå‘½: <span id="lives">3</span></div>
    </div>
    
    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="500" tabindex="0"></canvas>
        
        <div class="status-fix" id="statusFix">è·³è·ƒæœºåˆ¶ä¼˜åŒ–å®Œæˆ!</div>
        <div class="debug-panel">
            <div class="collision-indicator">
                <span>ç¢°æ’æ£€æµ‹:</span>
                <div class="collision-status" id="collisionStatus"></div>
            </div>
            <div>æŒ‰Fé”®åˆ‡æ¢è°ƒè¯•æ¨¡å¼</div>
        </div>
        <div class="sound-control" id="soundControl">ğŸ”Š éŸ³æ•ˆ: å¼€å¯</div>
        <div class="map-info">åœ°å›¾å°ºå¯¸: 3000x500åƒç´ </div>
        <div class="ability-indicator">
            <div class="ability">
                <div class="ability-icon" id="doubleJumpIcon">2</div>
                <div class="ability-text">äºŒæ®µè·³</div>
            </div>
            <div class="ability">
                <div class="ability-icon" id="invincibleIcon">ğŸ’«</div>
                <div class="ability-text">æ— æ•Œ</div>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>ä½ çš„å¾—åˆ†: <span id="finalScore">0</span></p>
            <p>æ”¶é›†çš„é‡‘å¸: <span id="finalCoins">0</span></p>
            <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    
    <div class="controls">
        <div class="key" data-action="å·¦ç§»" id="leftKey">A</div>
        <div class="key" data-action="è·³è·ƒ" id="upKey">W</div>
        <div class="key" data-action="å³ç§»" id="rightKey">D</div>
    </div>
    
    <div class="instructions">
        <p>ä½¿ç”¨ A/D é”®ç§»åŠ¨é©¬é‡Œå¥¥ï¼ŒW é”®è·³è·ƒï¼ˆå¯äºŒæ®µè·³ï¼‰ã€‚æ”¶é›†é‡‘å¸ï¼Œé¿å¼€æ•Œäººå’Œæ·±æ¸Šï¼</p>
        <p>æ–°å¢ç‰¹æ€§ï¼šä¼˜åŒ–è·³è·ƒæœºåˆ¶ã€WASDæ§åˆ¶ã€æ›´å¤šæ€ªç‰©ã€ç –å—æ¥¼æ¢¯ï¼</p>
        <p style="color: #4CAF50; margin-top: 10px; font-weight: bold;">è·³è·ƒä¼˜åŒ–ï¼šè¾¹ç¼˜è·³è·ƒæ›´æµç•…ï¼Œå¢åŠ è·³è·ƒç¼“å†²æ—¶é—´</p>
    </div>
    
    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // è®©canvasè·å¾—ç„¦ç‚¹ä»¥ä¾¿æ¥æ”¶é”®ç›˜äº‹ä»¶
        canvas.focus();
        
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            score: 0,
            coins: 0,
            lives: 3,
            gameOver: false,
            keys: {},
            camera: {
                x: 0,
                y: 0,
                width: canvas.width, // è§†å£å®½åº¦
                height: canvas.height
            },
            mapWidth: 3000, // æ›´å¤§çš„åœ°å›¾å°ºå¯¸
            mapHeight: 500,
            soundEnabled: true,
            debugMode: false,
            collisionActive: false,
            invincible: false,
            invincibleTimer: 0,
            invincibleBlink: false,
            jumpBuffer: 0, // è·³è·ƒç¼“å†²æ—¶é—´
            coyoteTime: 0  // è¾¹ç¼˜è·³è·ƒç¼“å†²
        };
        
        // æ¸¸æˆå…ƒç´ 
        const mario = {
            x: 100,
            y: 380, // åˆå§‹ä½ç½®åœ¨åœ°é¢ä¸Š
            width: 40,
            height: 60,
            speed: 5,
            velX: 0,
            velY: 0,
            jumping: false,
            grounded: true,
            direction: 'right',
            jumpCount: 0, // äºŒæ®µè·³è®¡æ•°
            canDoubleJump: true, // æ˜¯å¦å¯ä»¥äºŒæ®µè·³
            lastGroundedTime: 0 // è®°å½•æœ€åç«™åœ¨åœ°ä¸Šçš„æ—¶é—´
        };
        
        // é‡åŠ›
        const gravity = 0.5;
        const jumpStrength = 10; // å‡å°‘å•æ®µè·³è·ƒé«˜åº¦
        const doubleJumpStrength = 8; // äºŒæ®µè·³é«˜åº¦
        const jumpBufferTime = 0.1; // è·³è·ƒç¼“å†²æ—¶é—´ï¼ˆç§’ï¼‰
        const coyoteTime = 0.15; // è¾¹ç¼˜è·³è·ƒç¼“å†²æ—¶é—´ï¼ˆç§’ï¼‰
        
        // å¹³å°æ•°ç»„
        const platforms = [
            // åœ°é¢ - æœ‰å¤šä¸ªé—´éš™å½¢æˆæ·±æ¸Š
            {x: 0, y: 440, width: 600, height: 60, color: '#8B4513', topColor: '#4CAF50'},
            // ç¬¬ä¸€ä¸ªæ·±æ¸Šä¹‹åçš„åœ°é¢
            {x: 800, y: 440, width: 700, height: 60, color: '#8B4513', topColor: '#4CAF50'},
            // ç¬¬äºŒä¸ªæ·±æ¸Šä¹‹åçš„åœ°é¢
            {x: 1600, y: 440, width: 700, height: 60, color: '#8B4513', topColor: '#4CAF50'},
            // ç¬¬ä¸‰ä¸ªæ·±æ¸Šä¹‹åçš„åœ°é¢
            {x: 2400, y: 440, width: 600, height: 60, color: '#8B4513', topColor: '#4CAF50'},
            
            // å¹³å°
            {x: 200, y: 350, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 400, y: 380, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 600, y: 320, width: 150, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 300, y: 250, width: 80, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 500, y: 200, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 100, y: 300, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            
            // ç¬¬äºŒåŒºåŸŸå¹³å°
            {x: 900, y: 350, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 1100, y: 280, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 1300, y: 320, width: 150, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 1500, y: 250, width: 80, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            
            // ç¬¬ä¸‰åŒºåŸŸå¹³å°
            {x: 1700, y: 380, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 1900, y: 320, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 2100, y: 270, width: 80, height: 20, color: '#8B4513', topæColor: '#4CAF50'},
            {x: 2300, y: 320, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            
            // ç¬¬å››åŒºåŸŸå¹³å°
            {x: 2500, y: 350, width: 120, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 2700, y: 280, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
            {x: 2900, y: 320, width: 100, height: 20, color: '#8B4513', topColor: '#4CAF50'},
        ];
        
        // ç –å—æ¥¼æ¢¯
        const brickStairs = [
            // ç¬¬ä¸€æ®µæ¥¼æ¢¯
            {x: 400, y: 400, width: 40, height: 40},
            {x: 440, y: 360, width: 40, height: 40},
            {x: 480, y: 320, width: 40, height: 40},
            {x: 520, y: 280, width: 40, height: 40},
            
            // ç¬¬äºŒæ®µæ¥¼æ¢¯
            {x: 1200, y: 400, width: 40, height: 40},
            {x: 1240, y: 360, width: 40, height: 40},
            {x: 1280, y: 320, width: 40, height: 40},
            
            // ç¬¬ä¸‰æ®µæ¥¼æ¢¯
            {x: 2000, y: 400, width: 40, height: 40},
            {x: 2040, y: 360, width: 40, height: 40},
            {x: 2080, y: 320, width: 40, height: 40},
            {x: 2120, y: 280, width: 40, height: 40},
            
            // ç¬¬å››æ®µæ¥¼æ¢¯
            {x: 2600, y: 400, width: 40, height: 40},
            {x: 2640, y: 360, width: 40, height: 40},
            {x: 2680, y: 320, width: 40, height: 40},
        ];
        
        // ç»¿è‰²ç®¡é“æ•°ç»„ï¼ˆå¸¦ç¢°æ’ä½“ç§¯ï¼‰
        const pipes = [
            {x: 700, y: 380, width: 60, height: 60, top: 20},
            {x: 1200, y: 380, width: 60, height: 100, top: 20},
            {x: 1800, y: 380, width: 60, height: 80, top: 20},
            {x: 2200, y: 380, width: 60, height: 60, top: 20},
            {x: 2800, y: 380, width: 60, height: 100, top: 20}
        ];
        
        // é‡‘å¸æ•°ç»„
        const coins = [
            {x: 230, y: 320, width: 20, height: 20, collected: false},
            {x: 430, y: 350, width: 20, height: 20, collected: false},
            {x: 630, y: 290, width: 20, height: 20, collected: false},
            {x: 330, y: 220, width: 20, height: 20, collected: false},
            {x: 550, y: 170, width: 20, height: 20, collected: false},
            {x: 150, y: 400, width: 20, height: 20, collected: false},
            {x: 700, y: 400, width: 20, height: 20, collected: false},
            {x: 150, y: 270, width: 20, height: 20, collected: false},
            
            // ç¬¬äºŒåŒºåŸŸé‡‘å¸
            {x: 950, y: 320, width: 20, height: 20, collected: false},
            {x: 1150, y: 250, width: 20, height: 20, collected: false},
            {x: 1350, y: 290, width: 20, height: 20, collected: false},
            {x: 1550, y: 220, width: 20, height: 20, collected: false},
            
            // ç¬¬ä¸‰åŒºåŸŸé‡‘å¸
            {x: 1750, y: 350, width: 20, height: 20, collected: false},
            {x: 1950, y: 290, width: 20, height: 20, collected: false},
            {x: 2150, y: 240, width: 20, height: 20, collected: false},
            {x: 2350, y: 290, width: 20, height: 20, collected: false},
            
            // ç¬¬å››åŒºåŸŸé‡‘å¸
            {x: 2550, y: 320, width: 20, height: 20, collected: false},
            {x: 2750, y: 250, width: 20, height: 20, collected: false},
            {x: 2950, y: 290, width: 20, height: 20, collected: false}
        ];
        
        // æ•Œäººæ•°ç»„ï¼ˆæ›´å¤šæ€ªç‰©ï¼‰
        const enemies = [
            {x: 300, y: 400, width: 40, height: 40, direction: 1, speed: 1.5},
            {x: 550, y: 350, width: 40, height: 40, direction: -1, speed: 2},
            {x: 150, y: 280, width: 40, height: 40, direction: 1, speed: 1},
            
            // ç¬¬äºŒåŒºåŸŸæ•Œäºº
            {x: 900, y: 400, width: 40, height: 40, direction: 1, speed: 1.8},
            {x: 1100, y: 350, width: 40, height: 40, direction: -1, speed: 2.2},
            {x: 1300, y: 400, width: 40, height: 40, direction: 1, speed: 1.5},
            
            // ç¬¬ä¸‰åŒºåŸŸæ•Œäºº
            {x: 1700, y: 400, width: 40, height: 40, direction: 1, speed: 2.0},
            {x: 1900, y: 350, width: 40, height: 40, direction: -1, speed: 1.7},
            {x: 2100, y: 400, width: 40, height: 40, direction: 1, speed: 1.9},
            
            // ç¬¬å››åŒºåŸŸæ•Œäºº
            {x: 2500, y: 400, width: 40, height: 40, direction: 1, speed: 2.1},
            {x: 2700, y: 350, width: 40, height: 40, direction: -1, speed: 1.9},
            {x: 2900, y: 400, width: 40, height: 40, direction: 1, speed: 2.0},
            
            // æ–°å¢æ•Œäºº
            {x: 500, y: 400, width: 40, height: 40, direction: -1, speed: 1.6},
            {x: 1000, y: 280, width: 40, height: 40, direction: 1, speed: 1.4},
            {x: 1600, y: 400, width: 40, height: 40, direction: -1, speed: 2.0},
            {x: 2200, y: 280, width: 40, height: 40, direction: 1, speed: 1.8},
            {x: 2800, y: 400, width: 40, height: 40, direction: -1, speed: 1.7}
        ];
        
        // æ·±æ¸Šæ•°ç»„ï¼ˆæ— åœ°é¢åŒºåŸŸï¼‰
        const voids = [
            {x: 600, y: 440, width: 200, height: 60}, // ç¬¬ä¸€ä¸ªæ·±æ¸Š
            {x: 1500, y: 440, width: 100, height: 60}, // ç¬¬äºŒä¸ªæ·±æ¸Š
            {x: 2300, y: 440, width: 100, height: 60}  // ç¬¬ä¸‰ä¸ªæ·±æ¸Š
        ];
        
        // ç›¸æœºè·Ÿéšå‡½æ•°
        function updateCamera() {
            // ç›¸æœºå§‹ç»ˆè·Ÿéšé©¬é‡Œå¥¥ï¼Œä½†ä¿æŒåœ¨å±å¹•ä¸­å¤®
            gameState.camera.x = mario.x - gameState.camera.width / 2;
            
            // ç¡®ä¿ç›¸æœºä¸ä¼šç§»å‡ºåœ°å›¾è¾¹ç•Œ
            if (gameState.camera.x < 0) gameState.camera.x = 0;
            if (gameState.camera.x > gameState.mapWidth - gameState.camera.width) {
                gameState.camera.x = gameState.mapWidth - gameState.camera.width;
            }
        }
        
        // ç»˜åˆ¶é©¬é‡Œå¥¥
        function drawMario() {
            // è®¡ç®—æ¸²æŸ“ä½ç½®ï¼ˆè€ƒè™‘ç›¸æœºåç§»ï¼‰
            const renderX = mario.x - gameState.camera.x;
            const renderY = mario.y - gameState.camera.y;
            
            // æ— æ•Œé—ªçƒæ•ˆæœ
            if (gameState.invincible && gameState.invincibleBlink) {
                ctx.globalAlpha = 0.5;
            }
            
            ctx.fillStyle = '#E52521'; // çº¢è‰²å¸½å­
            ctx.fillRect(renderX, renderY, mario.width, 15);
            
            ctx.fillStyle = '#D2691E'; // æ£•è‰²å¤´å‘
            ctx.fillRect(renderX + 10, renderY + 15, mario.width - 20, 10);
            
            ctx.fillStyle = '#F5DEB3'; // è‚¤è‰²è„¸éƒ¨
            ctx.fillRect(renderX + 5, renderY + 25, mario.width - 10, 20);
            
            ctx.fillStyle = '#0000FF'; // è“è‰²è¡£æœ
            ctx.fillRect(renderX, renderY + 45, mario.width, 15);
            
            // çœ¼ç›
            ctx.fillStyle = 'black';
            ctx.fillRect(
                renderX + (mario.direction === 'right' ? 25 : 10), 
                renderY + 30, 
                5, 
                5
            );
            
            // å˜´å·´
            ctx.beginPath();
            ctx.arc(renderX + 20, renderY + 40, 5, 0, Math.PI);
            ctx.fill();
            
            // èƒ¡å­
            ctx.fillRect(renderX + 15, renderY + 38, 10, 2);
            
            // å¸½å­ä¸Šçš„M
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('M', renderX + 15, renderY + 12);
            
            // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
            if (gameState.debugMode) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(renderX, renderY, mario.width, mario.height);
            }
            
            // é‡ç½®é€æ˜åº¦
            ctx.globalAlpha = 1.0;
        }
        
        // ç»˜åˆ¶å¹³å°
        function drawPlatforms() {
            platforms.forEach(platform => {
                // è®¡ç®—æ¸²æŸ“ä½ç½®ï¼ˆè€ƒè™‘ç›¸æœºåç§»ï¼‰
                const renderX = platform.x - gameState.camera.x;
                const renderY = platform.y - gameState.camera.y;
                
                // å¹³å°ä¸»ä½“
                ctx.fillStyle = platform.color;
                ctx.fillRect(renderX, renderY, platform.width, platform.height);
                
                // å¹³å°é¡¶éƒ¨è‰
                ctx.fillStyle = platform.topColor;
                ctx.fillRect(renderX, renderY, platform.width, 5);
                
                // å¹³å°çº¹ç†
                ctx.fillStyle = '#A0522D';
                for (let i = 0; i < platform.width; i += 20) {
                    ctx.fillRect(renderX + i, renderY + 5, 10, platform.height - 5);
                }
                
                // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
                if (gameState.debugMode) {
                    ctx.strokeStyle = 'lime';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(renderX, renderY, platform.width, platform.height);
                }
            });
        }
        
        // ç»˜åˆ¶ç –å—æ¥¼æ¢¯
        function drawBrickStairs() {
            brickStairs.forEach(brick => {
                const renderX = brick.x - gameState.camera.x;
                const renderY = brick.y - gameState.camera.y;
                
                // ç –å—ä¸»ä½“
                ctx.fillStyle = '#C84C0C';
                ctx.fillRect(renderX, renderY, brick.width, brick.height);
                
                // ç –å—çº¹ç†
                ctx.fillStyle = '#B03A0A';
                ctx.fillRect(renderX, renderY, brick.width, 5);
                ctx.fillRect(renderX, renderY, 5, brick.height);
                ctx.fillRect(renderX + brick.width - 5, renderY, 5, brick.height);
                
                // ç –å—å†…éƒ¨çº¹ç†
                ctx.strokeStyle = '#A02A0A';
                ctx.lineWidth = 2;
                ctx.strokeRect(renderX + 10, renderY + 10, brick.width - 20, brick.height - 20);
                
                // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
                if (gameState.debugMode) {
                    ctx.strokeStyle = 'orange';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(renderX, renderY, brick.width, brick.height);
                }
            });
        }
        
        // ç»˜åˆ¶ç»¿è‰²ç®¡é“ï¼ˆå¸¦ç¢°æ’ä½“ç§¯ï¼‰
        function drawPipes() {
            pipes.forEach(pipe => {
                // è®¡ç®—æ¸²æŸ“ä½ç½®ï¼ˆè€ƒè™‘ç›¸æœºåç§»ï¼‰
                const renderX = pipe.x - gameState.camera.x;
                const renderY = pipe.y - gameState.camera.y;
                
                // ç®¡é“ä¸»ä½“
                ctx.fillStyle = '#55AA55';
                ctx.fillRect(renderX, renderY, pipe.width, pipe.height);
                
                // ç®¡é“é¡¶éƒ¨
                ctx.fillStyle = '#44CC44';
                ctx.fillRect(renderX - 5, renderY - pipe.top, pipe.width + 10, pipe.top);
                ctx.beginPath();
                ctx.arc(renderX + pipe.width/2, renderY - pipe.top, pipe.width/2 + 5, 0, Math.PI);
                ctx.fill();
                
                // ç®¡é“ç»†èŠ‚
                ctx.fillStyle = '#338833';
                ctx.fillRect(renderX + 10, renderY, 5, pipe.height);
                ctx.fillRect(renderX + pipe.width - 15, renderY, 5, pipe.height);
                
                // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
                if (gameState.debugMode) {
                    ctx.strokeStyle = '#AAFFAA';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(renderX, renderY - pipe.top, pipe.width, pipe.height + pipe.top);
                }
            });
        }
        
        // ç»˜åˆ¶é‡‘å¸
        function drawCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    // è®¡ç®—æ¸²æŸ“ä½ç½®ï¼ˆè€ƒè™‘ç›¸æœºåç§»ï¼‰
                    const renderX = coin.x - gameState.camera.x;
                    const renderY = coin.y - gameState.camera.y;
                    
                    // é‡‘å¸å¤–åœˆ
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(
                        renderX + coin.width/2, 
                        renderY + coin.height/2, 
                        coin.width/2, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // é‡‘å¸å†…åœˆ
                    ctx.fillStyle = '#DAA520';
                    ctx.beginPath();
                    ctx.arc(
                        renderX + coin.width/2, 
                        renderY + coin.height/2, 
                        coin.width/4, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // é‡‘å¸é«˜å…‰
                    ctx.fillStyle = '#FFF9C4';
                    ctx.beginPath();
                    ctx.arc(
                        renderX + coin.width/2 - 3, 
                        renderY + coin.height/2 - 3, 
                        3, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
                    if (gameState.debugMode) {
                        ctx.strokeStyle = 'yellow';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(renderX, renderY, coin.width, coin.height);
                    }
                }
            });
        }
        
        // ç»˜åˆ¶æ•Œäºº
        function drawEnemies() {
            enemies.forEach(enemy => {
                // è®¡ç®—æ¸²æŸ“ä½ç½®ï¼ˆè€ƒè™‘ç›¸æœºåç§»ï¼‰
                const renderX = enemy.x - gameState.camera.x;
                const renderY = enemy.y - gameState.camera.y;
                
                // æ•Œäººèº«ä½“
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.arc(
                    renderX + enemy.width/2, 
                    renderY + enemy.height/2, 
                    enemy.width/2, 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
                
                // æ•Œäººçœ¼ç›
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(
                    renderX + (enemy.direction > 0 ? 15 : 25), 
                    renderY + 15, 
                    5, 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(
                    renderX + (enemy.direction > 0 ? 15 : 25), 
                    renderY + 15, 
                    2, 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
                
                // è°ƒè¯•æ¨¡å¼ - ç»˜åˆ¶ç¢°æ’æ¡†
                if (gameState.debugMode) {
                    ctx.strokeStyle = 'cyan';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(renderX, renderY, enemy.width, enemy.height);
                }
            });
        }
        
        // ç»˜åˆ¶äº‘æœµ
        function drawClouds() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            
            // äº‘æœµ1
            ctx.beginPath();
            ctx.arc(100 - gameState.camera.x * 0.2, 80, 20, 0, Math.PI * 2);
            ctx.arc(130 - gameState.camera.x * 0.2, 70, 30, 0, Math.PI * 2);
            ctx.arc(160 - gameState.camera.x * 0.2, 80, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // äº‘æœµ2
            ctx.beginPath();
            ctx.arc(500 - gameState.camera.x * 0.2, 60, 25, 0, Math.PI * 2);
            ctx.arc(530 - gameState.camera.x * 0.2, 50, 35, 0, Math.PI * 2);
            ctx.arc(560 - gameState.camera.x * 0.2, 60, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // äº‘æœµ3
            ctx.beginPath();
            ctx.arc(300 - gameState.camera.x * 0.2, 100, 20, 0, Math.PI * 2);
            ctx.arc(330 - gameState.camera.x * 0.2, 90, 25, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ç»˜åˆ¶æ·±æ¸Š
        function drawVoids() {
            voids.forEach(v => {
                const renderX = v.x - gameState.camera.x;
                const renderY = v.y - gameState.camera.y;
                
                // ç»˜åˆ¶æ·±æ¸ŠèƒŒæ™¯ï¼ˆé»‘è‰²ï¼‰
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(renderX, renderY, v.width, v.height);
                
                // ç»˜åˆ¶æ·±æ¸Šè¾¹ç¼˜
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(renderX - 5, renderY, 5, v.height);
                ctx.fillRect(renderX + v.width, renderY, 5, v.height);
                
                // ç»˜åˆ¶æ·±æ¸Šå†…éƒ¨çº¹ç†
                ctx.fillStyle = 'rgba(50, 50, 50, 0.5)';
                for (let i = 0; i < v.width; i += 30) {
                    ctx.fillRect(renderX + i, renderY + 10, 20, 5);
                }
            });
        }
        
        // æ”¹è¿›çš„ç¢°æ’æ£€æµ‹å‡½æ•°
        function checkCollisions() {
            gameState.collisionActive = false;
            mario.grounded = false;
            
            // æ£€æµ‹å¹³å°ç¢°æ’
            for (const platform of platforms) {
                if (checkPlatformCollision(platform)) {
                    gameState.collisionActive = true;
                    return;
                }
            }
            
            // æ£€æµ‹ç –å—æ¥¼æ¢¯ç¢°æ’
            for (const brick of brickStairs) {
                if (checkPlatformCollision(brick)) {
                    gameState.collisionActive = true;
                    return;
                }
            }
            
            // æ£€æµ‹ç®¡é“ç¢°æ’
            for (const pipe of pipes) {
                const pipeCollider = {
                    x: pipe.x,
                    y: pipe.y - pipe.top,
                    width: pipe.width,
                    height: pipe.height + pipe.top
                };
                
                if (checkPlatformCollision(pipeCollider)) {
                    gameState.collisionActive = true;
                    return;
                }
            }
            
            // åœ°é¢ç¢°æ’
            if (mario.y + mario.height >= canvas.height - 60) {
                // æ£€æŸ¥æ˜¯å¦åœ¨æ·±æ¸Šä¸Šæ–¹
                for (const v of voids) {
                    if (mario.x + mario.width > v.x && mario.x < v.x + v.width) {
                        // åœ¨æ·±æ¸Šä¸Šæ–¹ï¼Œä¸ä¼šç¢°æ’
                        continue;
                    }
                }
                
                mario.y = canvas.height - 60 - mario.height;
                mario.velY = 0;
                mario.grounded = true;
                mario.jumping = false;
                mario.jumpCount = 0; // é‡ç½®è·³è·ƒè®¡æ•°
                mario.lastGroundedTime = Date.now() / 1000;
                gameState.collisionActive = true;
            }
            
            // æ›´æ–°ç¢°æ’æŒ‡ç¤ºå™¨
            document.getElementById('collisionStatus').className = 
                gameState.collisionActive ? 'collision-status active' : 'collision-status';
        }
        
        // æ£€æŸ¥å¹³å°ç¢°æ’çš„è¾…åŠ©å‡½æ•°
        function checkPlatformCollision(platform) {
            // æ£€æŸ¥æ°´å¹³é‡å 
            const horizontalOverlap = mario.x + mario.width > platform.x && 
                                     mario.x < platform.x + platform.width;
            
            // æ£€æŸ¥å‚ç›´é‡å 
            const verticalOverlap = mario.y + mario.height > platform.y && 
                                   mario.y < platform.y + platform.height;
            
            if (horizontalOverlap && verticalOverlap) {
                // è®¡ç®—ç¢°æ’æ–¹å‘
                const bottomCollision = mario.y + mario.height - platform.y;
                const topCollision = platform.y + platform.height - mario.y;
                const leftCollision = mario.x + mario.width - platform.x;
                const rightCollision = platform.x + platform.width - mario.x;
                
                // æ‰¾å‡ºæœ€å°é‡å æ–¹å‘
                const minOverlap = Math.min(bottomCollision, topCollision, leftCollision, rightCollision);
                
                // æ ¹æ®æœ€å°é‡å æ–¹å‘å¤„ç†ç¢°æ’
                if (minOverlap === bottomCollision) {
                    // ä»ä¸Šæ–¹ç¢°æ’
                    mario.y = platform.y - mario.height;
                    mario.velY = 0;
                    mario.grounded = true;
                    mario.jumping = false;
                    mario.jumpCount = 0; // é‡ç½®è·³è·ƒè®¡æ•°
                    mario.lastGroundedTime = Date.now() / 1000;
                } else if (minOverlap === topCollision) {
                    // ä»ä¸‹æ–¹ç¢°æ’ï¼ˆç¢°å¤´æ•ˆæœï¼‰
                    mario.y = platform.y + platform.height;
                    mario.velY = 0;
                } else if (minOverlap === leftCollision) {
                    // ä»å·¦ä¾§ç¢°æ’
                    mario.x = platform.x - mario.width;
                } else if (minOverlap === rightCollision) {
                    // ä»å³ä¾§ç¢°æ’
                    mario.x = platform.x + platform.width;
                }
                
                return true;
            }
            return false;
        }
        
        // æ›´æ–°æ— æ•ŒçŠ¶æ€
        function updateInvincibility(deltaTime) {
            if (gameState.invincible) {
                gameState.invincibleTimer -= deltaTime;
                
                // æ›´æ–°é—ªçƒæ•ˆæœ
                gameState.invincibleBlink = Math.floor(gameState.invincibleTimer * 10) % 2 === 0;
                
                // æ›´æ–°UIæŒ‡ç¤ºå™¨
                document.getElementById('invincibleIcon').style.color = gameState.invincibleBlink ? '#FFD700' : '#FFFFFF';
                
                if (gameState.invincibleTimer <= 0) {
                    gameState.invincible = false;
                    document.getElementById('invincibleIcon').style.color = '#FFFFFF';
                }
            }
        }
        
        // æ›´æ–°è·³è·ƒç¼“å†²
        function updateJumpBuffer(deltaTime) {
            if (gameState.jumpBuffer > 0) {
                gameState.jumpBuffer -= deltaTime;
            }
            
            // æ›´æ–°coyote time
            if (!mario.grounded) {
                gameState.coyoteTime -= deltaTime;
            } else {
                gameState.coyoteTime = coyoteTime;
            }
        }
        
        // æ‰§è¡Œè·³è·ƒ
        function performJump() {
            // ç¬¬ä¸€æ¬¡è·³è·ƒï¼ˆåœ¨åœ°é¢ä¸Šï¼‰
            if (!mario.jumping && (mario.grounded || gameState.coyoteTime > 0)) {
                mario.velY = -jumpStrength;
                mario.jumping = true;
                mario.grounded = false;
                mario.jumpCount = 1;
                document.getElementById('upKey').classList.add('active');
                return true;
            } 
            // äºŒæ®µè·³ï¼ˆåœ¨ç©ºä¸­ä¸”è¿˜æœªä½¿ç”¨äºŒæ®µè·³ï¼‰
            else if (mario.jumping && mario.canDoubleJump && !mario.grounded && mario.jumpCount < 2) {
                mario.velY = -doubleJumpStrength;
                mario.jumpCount = 2;
                mario.canDoubleJump = false;
                return true;
            }
            return false;
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function update() {
            if (gameState.gameOver) return;
            
            const deltaTime = 1/60; // å‡è®¾60fps
            const currentTime = Date.now() / 1000;
            
            // æ›´æ–°æ— æ•ŒçŠ¶æ€
            updateInvincibility(deltaTime);
            
            // æ›´æ–°è·³è·ƒç¼“å†²
            updateJumpBuffer(deltaTime);
            
            // åº”ç”¨é‡åŠ›
            if (!mario.grounded) {
                mario.velY += gravity;
            } else {
                mario.velY = 0;
                mario.canDoubleJump = true; // è½åœ°åé‡ç½®äºŒæ®µè·³
                mario.lastGroundedTime = currentTime;
            }
            
            // æ›´æ–°ä½ç½®
            mario.x += mario.velX;
            mario.y += mario.velY;
            
            // ç¢°æ’æ£€æµ‹
            checkCollisions();
            
            // è¾¹ç•Œæ£€æµ‹
            if (mario.x < 0) mario.x = 0;
            if (mario.x + mario.width > gameState.mapWidth) {
                mario.x = gameState.mapWidth - mario.width;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰å…¥æ·±æ¸Š
            if (mario.y > canvas.height) {
                loseLife();
            } else {
                // æ£€æŸ¥æ˜¯å¦åœ¨æ·±æ¸ŠåŒºåŸŸä¸Šæ–¹
                for (const v of voids) {
                    if (mario.x + mario.width > v.x && mario.x < v.x + v.width) {
                        if (mario.y + mario.height > v.y) {
                            // æ‰å…¥æ·±æ¸Š
                            loseLife();
                            return;
                        }
                    }
                }
            }
            
            // é‡‘å¸æ”¶é›†æ£€æµ‹
            coins.forEach(coin => {
                if (!coin.collected && isColliding(mario, coin)) {
                    coin.collected = true;
                    gameState.coins++;
                    gameState.score += 100;
                    updateStats();
                }
            });
            
            // æ•Œäººç¢°æ’æ£€æµ‹ (æ— æ•ŒçŠ¶æ€ä¸‹ä¸å—ä¼¤å®³)
            if (!gameState.invincible) {
                enemies.forEach(enemy => {
                    // ç§»åŠ¨æ•Œäºº
                    enemy.x += enemy.speed * enemy.direction;
                    
                    // è¾¹ç•Œæ£€æµ‹ï¼ˆåè½¬æ–¹å‘ï¼‰
                    if (enemy.x < 0 || enemy.x + enemy.width > gameState.mapWidth) {
                        enemy.direction *= -1;
                    }
                    
                    // æ£€æµ‹é©¬é‡Œå¥¥ä¸æ•Œäººç¢°æ’
                    if (isColliding(mario, enemy)) {
                        // å¦‚æœé©¬é‡Œå¥¥åœ¨æ•Œäººä¸Šæ–¹
                        if (mario.y + mario.height < enemy.y + enemy.height/2 && mario.velY > 0) {
                            // æ¶ˆç­æ•Œäºº
                            enemy.y = canvas.height + 100; // ç§»å‡ºå±å¹•
                            mario.velY = -10; // åå¼¹
                            gameState.score += 200;
                            updateStats();
                        } else {
                            // é©¬é‡Œå¥¥è¢«æ•Œäººä¼¤å®³
                            loseLife();
                        }
                    }
                });
            }
            
            // æ›´æ–°ç›¸æœºä½ç½®
            updateCamera();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStats();
            
            // å¤„ç†è·³è·ƒç¼“å†²
            if (gameState.jumpBuffer > 0) {
                if (performJump()) {
                    gameState.jumpBuffer = 0;
                }
            }
        }
        
        // ç¢°æ’æ£€æµ‹å‡½æ•°
        function isColliding(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }
        
        // å¤±å»ç”Ÿå‘½
        function loseLife() {
            gameState.lives--;
            if (gameState.lives <= 0) {
                gameState.gameOver = true;
                setTimeout(() => {
                    document.getElementById('gameOver').classList.add('show');
                }, 500);
                document.getElementById('finalScore').textContent = gameState.score;
                document.getElementById('finalCoins').textContent = gameState.coins;
            } else {
                // é‡ç½®é©¬é‡Œå¥¥ä½ç½®å¹¶æ¿€æ´»æ— æ•ŒçŠ¶æ€
                resetMarioPosition();
                activateInvincibility(3); // 3ç§’æ— æ•Œ
            }
            updateStats();
        }
        
        // æ¿€æ´»æ— æ•ŒçŠ¶æ€
        function activateInvincibility(duration) {
            gameState.invincible = true;
            gameState.invincibleTimer = duration;
            document.getElementById('invincibleIcon').style.color = '#FFD700';
        }
        
        // é‡ç½®é©¬é‡Œå¥¥ä½ç½®
        function resetMarioPosition() {
            mario.x = 100;
            mario.y = 380;
            mario.velX = 0;
            mario.velY = 0;
            mario.grounded = true;
            mario.jumpCount = 0;
            mario.lastGroundedTime = Date.now() / 1000;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('lives').textContent = gameState.lives;
            
            // æ›´æ–°äºŒæ®µè·³æŒ‡ç¤ºå™¨
            document.getElementById('doubleJumpIcon').style.backgroundColor = 
                mario.canDoubleJump ? 'rgba(100, 200, 100, 0.8)' : 'rgba(200, 100, 100, 0.8)';
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶äº‘æœµ
            drawClouds();
            
            // ç»˜åˆ¶å¹³å°
            drawPlatforms();
            
            // ç»˜åˆ¶ç –å—æ¥¼æ¢¯
            drawBrickStairs();
            
            // ç»˜åˆ¶ç®¡é“
            drawPipes();
            
            // ç»˜åˆ¶é‡‘å¸
            drawCoins();
            
            // ç»˜åˆ¶æ•Œäºº
            drawEnemies();
            
            // ç»˜åˆ¶æ·±æ¸Š
            drawVoids();
            
            // ç»˜åˆ¶é©¬é‡Œå¥¥
            drawMario();
            
            // ç»˜åˆ¶åˆ†æ•°å’Œç”Ÿå‘½å€¼
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(10, 10, 180, 50);
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText(`å¾—åˆ†: ${gameState.score}`, 20, 30);
            ctx.fillText(`é‡‘å¸: ${gameState.coins}`, 20, 60);
            
            // è°ƒè¯•ä¿¡æ¯
            if (gameState.debugMode) {
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`ä½ç½®: (${Math.floor(mario.x)}, ${Math.floor(mario.y)})`, canvas.width - 200, 30);
                ctx.fillText(`ç›¸æœº: ${Math.floor(gameState.camera.x)}`, canvas.width - 200, 50);
                ctx.fillText(`é€Ÿåº¦: (${mario.velX.toFixed(1)}, ${mario.velY.toFixed(1)})`, canvas.width - 200, 70);
                ctx.fillText(`çŠ¶æ€: ${mario.grounded ? 'åœ°é¢' : 'ç©ºä¸­'}`, canvas.width - 200, 90);
                ctx.fillText(`è·³è·ƒ: ${mario.jumpCount}`, canvas.width - 200, 110);
                ctx.fillText(`æ— æ•Œ: ${gameState.invincible ? 'æ˜¯' : 'å¦'}`, canvas.width - 200, 130);
                ctx.fillText(`ç¼“å†²: ${gameState.jumpBuffer.toFixed(2)}`, canvas.width - 200, 150);
            }
        }
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            gameState.keys[e.keyCode] = true;
            
            // Aé”®
            if (e.keyCode === 65) {
                mario.velX = -mario.speed;
                mario.direction = 'left';
                document.getElementById('leftKey').classList.add('active');
            }
            
            // Dé”®
            if (e.keyCode === 68) {
                mario.velX = mario.speed;
                mario.direction = 'right';
                document.getElementById('rightKey').classList.add('active');
            }
            
            // Wé”® (è·³è·ƒ)
            if (e.keyCode === 87) {
                // è®¾ç½®è·³è·ƒç¼“å†²
                gameState.jumpBuffer = jumpBufferTime;
                document.getElementById('upKey').classList.add('active');
            }
            
            // Fé”® - è°ƒè¯•æ¨¡å¼
            if (e.keyCode === 70) {
                gameState.debugMode = !gameState.debugMode;
            }
        });
        
        document.addEventListener('keyup', function(e) {
            gameState.keys[e.keyCode] = false;
            
            // åœæ­¢æ°´å¹³ç§»åŠ¨
            if (e.keyCode === 65) {
                mario.velX = 0;
                document.getElementById('leftKey').classList.remove('active');
            }
            if (e.keyCode === 68) {
                mario.velX = 0;
                document.getElementById('rightKey').classList.remove('active');
            }
            if (e.keyCode === 87) {
                document.getElementById('upKey').classList.remove('active');
            }
        });
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        document.getElementById('restartBtn').addEventListener('click', function() {
            gameState.score = 0;
            gameState.coins = 0;
            gameState.lives = 3;
            gameState.gameOver = false;
            gameState.invincible = false;
            
            // é‡ç½®é©¬é‡Œå¥¥
            resetMarioPosition();
            
            // é‡ç½®é‡‘å¸
            coins.forEach(coin => {
                coin.collected = false;
            });
            
            // é‡ç½®æ•Œäºº
            enemies.forEach((enemy, i) => {
                // ä¿ç•™åˆå§‹ä½ç½®
                enemies[i].y = 400;
            });
            
            document.getElementById('gameOver').classList.remove('show');
            updateStats();
            
            // æ˜¾ç¤ºä¿®å¤çŠ¶æ€
            const statusFix = document.getElementById('statusFix');
            statusFix.style.display = 'block';
            setTimeout(() => {
                statusFix.style.display = 'none';
            }, 3000);
        });
        
        // éŸ³æ•ˆæ§åˆ¶
        document.getElementById('soundControl').addEventListener('click', function() {
            gameState.soundEnabled = !gameState.soundEnabled;
            this.textContent = gameState.soundEnabled ? 'ğŸ”Š éŸ³æ•ˆ: å¼€å¯' : 'ğŸ”‡ éŸ³æ•ˆ: å…³é—­';
        });
        
        // åˆå§‹åŒ–ç¢°æ’æŒ‡ç¤ºå™¨
        document.getElementById('collisionStatus').className = 'collision-status';
        
        // åˆå§‹æ›´æ–°ç›¸æœºä½ç½®
        updateCamera();
        
        // å¯åŠ¨æ¸¸æˆ
        gameLoop();
    </script>
</body>
</html>
